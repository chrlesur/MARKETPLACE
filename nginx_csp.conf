# Serveur HTTPS pour le nom de domaine
server {
    server_name market.quantum-dream.net;
    root /var/www/marketplace/frontend;
    index index.html index.htm;

    # Configuration pour Let's Encrypt
    location ~ /.well-known/acme-challenge {
        allow all;
        root /var/www/market.quantum-dream.net/html;
    }

    # Configuration pour la marketplace
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Configuration pour l'interface d'administration
    location /admin {
        try_files $uri $uri/ /index.html;
    }

    # Configuration pour l'application Transkryptor
    location /transkryptor {
        alias /var/www/marketplace/apps/transkryptor/public;
        try_files $uri $uri/ /transkryptor/index.html;
    }

    # Configuration pour les API
    location /api {
        proxy_pass http://localhost:3001\;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # Configuration pour l'endpoint test-keys
    location /test-keys {
        # Autoriser explicitement les méthodes POST
        limit_except GET POST OPTIONS {
            deny all;
        }

        proxy_pass http://localhost:3001/test-keys\;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;

        # Autoriser les méthodes POST
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Methods' 'GET POST OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'DNT User-Agent X-Requested-With If-Modified-Since Cache-Control Content-Type Range';
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Type' 'text/plain; charset=utf-8';
            add_header 'Content-Length' 0;
            return 204;
        }
        if ($request_method = 'POST') {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Methods' 'GET POST OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'DNT User-Agent X-Requested-With If-Modified-Since Cache-Control Content-Type Range';
            add_header 'Access-Control-Expose-Headers' 'Content-Length Content-Range';
        }
    }

    # Configuration de sécurité
    server_tokens off;
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options SAMEORIGIN;
    add_header X-XSS-Protection "1; mode=block";
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data:; font-src 'self' data: https://fonts.gstatic.com; connect-src 'self'";

    # Configuration pour les fichiers statiques
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg)$ {
        expires 30d;
        add_header Cache-Control "public, no-transform";
    }

    listen [::]:443 ssl ipv6only=on; # managed by Certbot
    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/market.quantum-dream.net/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/market.quantum-dream.net/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}

# Redirection HTTP vers HTTPS pour le nom de domaine
server {
    listen 80;
    listen [::]:80;
    server_name market.quantum-dream.net;

    return 301 https://$host$request_uri\;
}

# Serveur par défaut pour l'adresse IP
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    root /var/www/marketplace/frontend;
    index index.html index.htm;

    location / {
        try_files $uri $uri/ /index.html;
    }

    # Configuration de sécurité
    server_tokens off;
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options SAMEORIGIN;
    add_header X-XSS-Protection "1; mode=block";
}
